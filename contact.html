<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contact Us - RPG Memory Battle</title>

  <link rel="stylesheet" href="./assets/css/style.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    html, body { height: 100%; }
    body {
      position: relative; display: flex; flex-direction: column; justify-content: flex-start; align-items: center;
      min-height: 100vh; padding: 40px 15px; color: #f0f0f0; overflow-x: hidden;
    }
    body::before{
      content:""; position:fixed; inset:0; background:url("./assets/images/bck_img.png") center/cover no-repeat; z-index:-1; pointer-events:none;
    }
    .contact-wrapper{ background:rgba(0,0,0,.75); border:3px solid #ffcc00; border-radius:15px; padding:25px; max-width:700px; width:100%; box-shadow:0 10px 30px rgba(0,0,0,.6); }
    .contact-wrapper h1{ color:#ffcc00; margin-bottom:15px; text-align:center; }
    .contact-wrapper p{ color:#ccc; text-align:center; margin-bottom:25px; }
    .form-group{ margin-bottom:15px; }
    label{ display:block; font-weight:700; margin-bottom:6px; color:#ffcc00; }
    input,textarea{ width:100%; padding:10px; border-radius:8px; border:2px solid #555; background:#222; color:#fff; font-size:1rem; outline:none; }
    input:focus,textarea:focus{ border-color:#ffcc00; }
    textarea{ resize:vertical; min-height:120px; }
    .form-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:20px; }
    .btn{ background:linear-gradient(to right,#2ecc71,#27ae60); color:#fff; border:0; padding:10px 18px; border-radius:8px; font-weight:700; cursor:pointer; transition:.3s; }
    .btn:hover{ background:linear-gradient(to right,#27ae60,#2ecc71); }
    .btn[disabled]{ opacity:.7; cursor:not-allowed; }
    footer{ margin-top:30px; text-align:center; color:#aaa; }
    footer a{ color:#ffcc00; margin:0 8px; text-decoration:none; }
    footer a:hover{ text-decoration:underline; }
    @media (max-width:360px){ body{ padding:28px 12px; } .contact-wrapper{ padding:18px; border-width:2px; width:92vw; max-width:92vw; } .form-actions{ gap:8px; } }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{ background:#111; border:2px solid #ffcc00; border-radius:12px; max-width:520px; width:calc(100% - 40px); padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.7); }
    .modal h2{ margin:0 0 10px; color:#ffcc00; font-size:1.25rem; }
    .modal p{ margin:0 0 16px; color:#eaeaea; white-space:pre-wrap; }
    .modal .actions{ display:flex; gap:10px; justify-content:flex-end; }
    .modal .btn{ background:linear-gradient(to right,#f1c40f,#e67e22); color:#111; }
    .hidden-hp{ position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
  </style>
</head>
<body>
  <div class="contact-wrapper" role="main">
    <h1>Contact Us</h1>
    <p>Send us your feedback, ideas, or questions about RPG Memory Battle.</p>

    <form id="contact-form" novalidate>
      <label class="hidden-hp">Leave this field empty
        <input type="text" name="_honeypot" autocomplete="off" tabindex="-1" />
      </label>

      <div class="form-group">
        <label for="from_name">Your Name</label>
        <input id="from_name" name="from_name" type="text" required autocomplete="name" placeholder="e.g., Leon Freeman"/>
      </div>

      <div class="form-group">
        <label for="reply_to">Email Address</label>
        <input id="reply_to" name="reply_to" type="email" required autocomplete="email" placeholder="you@example.com"/>
      </div>

      <div class="form-group">
        <label for="message">Message</label>
        <textarea id="message" name="message" required placeholder="How can we help?"></textarea>
      </div>

      <input type="hidden" id="page_url" value=""/>

      <div class="form-actions">
        <button type="submit" id="btn-send" class="btn"><i class="fa-regular fa-paper-plane"></i> Send Message</button>
        <button type="button" id="btn-return" class="btn" aria-label="Return to the previous page">Return</button>
      </div>

      <p id="form-status" aria-live="polite" style="text-align:center;margin-top:10px;"></p>
    </form>
  </div>

  <footer>
    <p><a href="https://github.com/leon4721/Project-RPG" target="_blank" rel="noopener"><i class="fab fa-github"></i> GitHub</a></p>
    <p>&copy; 2025 RPG Memory Battle</p>
  </footer>

  <div id="modal-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <h2 id="modal-title">Notice</h2>
      <p id="modal-message">Message text</p>
      <div class="actions">
        <button type="button" id="modal-ok" class="btn" aria-label="Close popup">OK</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    // Modal helpers
    const modalBackdrop=document.getElementById('modal-backdrop');
    const modalTitle=document.getElementById('modal-title');
    const modalMsg=document.getElementById('modal-message');
    const modalOk=document.getElementById('modal-ok');
    function showModal(t,m){ modalTitle.textContent=t||'Notice'; modalMsg.textContent=m||''; modalBackdrop.style.display='flex'; modalBackdrop.setAttribute('aria-hidden','false'); modalOk.focus(); }
    function hideModal(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); }
    modalOk.addEventListener('click',hideModal);
    modalBackdrop.addEventListener('click',(e)=>{ if(e.target===modalBackdrop) hideModal(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && modalBackdrop.getAttribute('aria-hidden')==='false') hideModal(); });

    // Smart Return
    (function(){
      const btn=document.getElementById('btn-return');
      if(!btn) return;
      btn.addEventListener('click',()=>{
        try{
          const ref=document.referrer;
          if(ref && new URL(ref).origin===location.origin){ history.back(); }
          else{ window.location.href='index.html'; }
        }catch{ window.location.href='index.html'; }
      });
    })();

    // EmailJS config
    const PUBLIC_KEY='K7MPJRPc2Z9q4R3gh'; // 
    const SERVICE_ID='service_3g1qw6b';
    const TEMPLATE_ID='template_n9as6o4'; // change only if your template differs

    try{
      emailjs.init(PUBLIC_KEY);
    }catch(e){
      console.error('[EmailJS] init failed:', e);
    }

    // Form logic (explicit mapping + detailed errors)
    (function(){
      const form=document.getElementById('contact-form');
      const status=document.getElementById('form-status');
      const sendBtn=document.getElementById('btn-send');
      const pageUrl=document.getElementById('page_url');
      if(pageUrl) pageUrl.value=window.location.href;

      const loadTime=Date.now();

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();

        if(!form.checkValidity()){
          status.textContent='Please fill in all required fields.';
          showModal('Missing Information','Please fill in all required fields before sending.');
          return;
        }
        if(form._honeypot && form._honeypot.value){ return; }
        if(Date.now()-loadTime<1200){
          status.textContent='Please wait a moment before sending.';
          showModal('Slow down','Please wait a moment before sending.');
          return;
        }

        const params={
          from_name: document.getElementById('from_name').value.trim(),
          reply_to:  document.getElementById('reply_to').value.trim(),
          message:   document.getElementById('message').value.trim(),
          subject:   'RPG Memory Battle – Contact Form',
          page_url:  pageUrl ? pageUrl.value : location.href
        };

        try{
          sendBtn.disabled=true;
          status.textContent='Sending…';

          const res=await emailjs.send(SERVICE_ID, TEMPLATE_ID, params);

          status.textContent='Thanks! Your message has been sent.';
          showModal('Message Sent','Thanks! Your message has been sent. We’ll get back to you shortly.');
          form.reset();
          if(pageUrl) pageUrl.value=window.location.href;
          console.log('[EmailJS] success:', res);
        }catch(err){
          console.error('[EmailJS] send error:', err);
          const raw=(err && (err.text || err.message)) ? (err.text || err.message) : JSON.stringify(err);
          let friendly='Sorry, sending failed. Please try again in a moment.';
          const lower=String(raw).toLowerCase();
          if(lower.includes('user id') || lower.includes('public key')){
            friendly='Email service is not initialized correctly. Double-check your Public Key (must start with "public_").';
          }else if(lower.includes('service') || lower.includes('template')){
            friendly='Email template or service not found. Verify Service ID and Template ID.';
          }else if(lower.includes('unauthorized') || lower.includes('401')){
            friendly='Unauthorized. Ensure the Public Key belongs to your EmailJS account.';
          }
          status.textContent=friendly;
          showModal('Send Failed', `${friendly}\n\nDetails: ${raw}`);
        }finally{
          sendBtn.disabled=false;
        }
      });
    })();
  </script>
</body>
</html>
